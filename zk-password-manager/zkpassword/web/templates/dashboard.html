{% extends "base.html" %}

{% block title %}Dashboard - Zero-Knowledge Password Manager{% endblock %}

{% block content %}
<div class="row">
    <!-- Vault Info Panel -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="card-title">
                            <i class="bi bi-safe text-success me-2"></i>
                            Vault Dashboard
                        </h5>
                        <p class="text-muted mb-0">
                            <strong>{{ vault_info.entry_count }}</strong> entries stored securely
                        </p>
                        <small class="text-muted">
                            Created: {{ vault_info.created_at[:10] }}
                        </small>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addEntryModal">
                            <i class="bi bi-plus-lg me-1"></i>
                            Add Entry
                        </button>
                        <button class="btn btn-primary" onclick="generatePassword()">
                            <i class="bi bi-shuffle me-1"></i>
                            Generate Password
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Search and Filter -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control" id="searchInput" 
                                   placeholder="Search passwords by service, username, or URL...">
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-outline-primary" onclick="refreshEntries()">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Password Entries Table -->
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>
                    Password Entries
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-striped mb-0" id="entriesTable">
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th>Username</th>
                                <th>URL</th>
                                <th>Last Modified</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in entries %}
                            <tr data-service="{{ entry.service }}" data-username="{{ entry.username }}">
                                <td>
                                    <strong>{{ entry.service }}</strong>
                                </td>
                                <td>{{ entry.username }}</td>
                                <td>
                                    {% if entry.url %}
                                        <a href="{{ entry.url }}" target="_blank" class="text-info">
                                            {{ entry.url[:30] }}{% if entry.url|length > 30 %}...{% endif %}
                                        </a>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">{{ entry.modified_at[:16] }}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="copyPassword('{{ entry.service }}', '{{ entry.username }}')" title="Copy Password">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                        <button class="btn btn-outline-info" onclick="viewPassword('{{ entry.service }}', '{{ entry.username }}')" title="View Password">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="editEntry('{{ entry.service }}', '{{ entry.username }}')" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteEntry('{{ entry.service }}', '{{ entry.username }}')" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if not entries %}
                <div class="text-center py-5">
                    <i class="bi bi-inbox" style="font-size: 3rem; color: var(--text-secondary);"></i>
                    <h5 class="mt-3 text-muted">No passwords stored yet</h5>
                    <p class="text-muted">Click "Add Entry" to create your first password entry</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Entry Modal -->
<div class="modal fade" id="addEntryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Add New Password Entry</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="addEntryForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="addService" class="form-label">Service Name *</label>
                        <input type="text" class="form-control" id="addService" required>
                    </div>
                    <div class="mb-3">
                        <label for="addUsername" class="form-label">Username *</label>
                        <input type="text" class="form-control" id="addUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="addPassword" class="form-label">Password *</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="addPassword" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('addPassword')">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-primary" type="button" onclick="generatePasswordForForm('addPassword')">
                                <i class="bi bi-shuffle"></i>
                            </button>
                        </div>
                        <div id="addPasswordStrength" class="password-strength"></div>
                    </div>
                    <div class="mb-3">
                        <label for="addUrl" class="form-label">URL</label>
                        <input type="url" class="form-control" id="addUrl">
                    </div>
                    <div class="mb-3">
                        <label for="addNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="addNotes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Entry</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Entry Modal -->
<div class="modal fade" id="editEntryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Password Entry</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editEntryForm">
                <div class="modal-body">
                    <input type="hidden" id="editOriginalService">
                    <input type="hidden" id="editOriginalUsername">
                    <div class="mb-3">
                        <label for="editService" class="form-label">Service Name *</label>
                        <input type="text" class="form-control" id="editService" required>
                    </div>
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">Username *</label>
                        <input type="text" class="form-control" id="editUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPassword" class="form-label">Password *</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="editPassword" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('editPassword')">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-primary" type="button" onclick="generatePasswordForForm('editPassword')">
                                <i class="bi bi-shuffle"></i>
                            </button>
                        </div>
                        <div id="editPasswordStrength" class="password-strength"></div>
                    </div>
                    <div class="mb-3">
                        <label for="editUrl" class="form-label">URL</label>
                        <input type="url" class="form-control" id="editUrl">
                    </div>
                    <div class="mb-3">
                        <label for="editNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="editNotes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Update Entry</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Password Modal -->
<div class="modal fade" id="viewPasswordModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Password</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Service: <span id="viewPasswordService"></span></label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="viewPasswordField" readonly>
                        <button class="btn btn-outline-primary" type="button" onclick="copyToClipboard('viewPasswordField')">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
                <div class="alert alert-warning">
                    <small><i class="bi bi-shield-exclamation me-1"></i>This password will be hidden when you close this window.</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Password Generator Modal -->
<div class="modal fade" id="passwordGeneratorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Password Generator</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="passwordLength" class="form-label">Length</label>
                        <input type="range" class="form-range" id="passwordLength" min="8" max="64" value="16" oninput="updateLengthDisplay()">
                        <div class="text-center">
                            <small class="text-muted">Length: <span id="lengthDisplay">16</span></small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Options</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeSymbols" checked>
                            <label class="form-check-label" for="includeSymbols">Include Symbols</label>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary w-100 mb-3" onclick="generateModalPassword()">
                    <i class="bi bi-shuffle me-2"></i>
                    Generate Password
                </button>
                
                <div class="mb-3">
                    <label class="form-label">Generated Password</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="generatedPassword" readonly>
                        <button class="btn btn-outline-primary" type="button" onclick="copyToClipboard('generatedPassword')">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                    <div id="generatedPasswordStrength" class="password-strength"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Search functionality
    document.getElementById('searchInput').addEventListener('input', function() {
        const query = this.value.toLowerCase();
        const rows = document.querySelectorAll('#entriesTable tbody tr');
        
        rows.forEach(row => {
            const service = row.children[0].textContent.toLowerCase();
            const username = row.children[1].textContent.toLowerCase();
            const url = row.children[2].textContent.toLowerCase();
            
            if (service.includes(query) || username.includes(query) || url.includes(query)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
    
    // Add entry form submission
    document.getElementById('addEntryForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const data = {
            service: document.getElementById('addService').value,
            username: document.getElementById('addUsername').value,
            password: document.getElementById('addPassword').value,
            url: document.getElementById('addUrl').value,
            notes: document.getElementById('addNotes').value
        };
        
        try {
            const response = await fetch('/api/entries/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('addEntryModal')).hide();
                showToast('Entry added successfully!', 'success');
                location.reload();
            } else {
                const error = await response.json();
                showToast('Error: ' + error.error, 'danger');
            }
        } catch (error) {
            showToast('Network error: ' + error.message, 'danger');
        }
    });
    
    // Edit entry form submission
    document.getElementById('editEntryForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const data = {
            old_service: document.getElementById('editOriginalService').value,
            old_username: document.getElementById('editOriginalUsername').value,
            service: document.getElementById('editService').value,
            username: document.getElementById('editUsername').value,
            password: document.getElementById('editPassword').value,
            url: document.getElementById('editUrl').value,
            notes: document.getElementById('editNotes').value
        };
        
        try {
            const response = await fetch('/api/entries/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('editEntryModal')).hide();
                location.reload();
            } else {
                const error = await response.json();
                alert('Error: ' + error.error);
            }
        } catch (error) {
            alert('Network error: ' + error.message);
        }
    });
    
    // Password visibility toggle
    function togglePasswordVisibility(inputId) {
        const input = document.getElementById(inputId);
        const button = event.target.closest('button');
        const icon = button.querySelector('i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.className = 'bi bi-eye-slash';
        } else {
            input.type = 'password';
            icon.className = 'bi bi-eye';
        }
    }
    
    // Generate password for form
    async function generatePasswordForForm(inputId) {
        try {
            const response = await fetch('/api/generate_password?length=20&symbols=true');
            const data = await response.json();
            
            document.getElementById(inputId).value = data.password;
            
            // Update strength indicator
            const strengthId = inputId + 'Strength';
            const strengthElement = document.getElementById(strengthId);
            if (strengthElement) {
                strengthElement.innerHTML = `<span class="strength-${data.strength.toLowerCase().replace(' ', '-')}">${data.strength}</span> (${data.entropy.toFixed(1)} bits)`;
            }
        } catch (error) {
            alert('Error generating password: ' + error.message);
        }
    }
    
    // Password generator modal
    function generatePassword() {
        new bootstrap.Modal(document.getElementById('passwordGeneratorModal')).show();
    }
    
    function updateLengthDisplay() {
        document.getElementById('lengthDisplay').textContent = document.getElementById('passwordLength').value;
    }
    
    async function generateModalPassword() {
        const length = document.getElementById('passwordLength').value;
        const symbols = document.getElementById('includeSymbols').checked;
        
        try {
            const response = await fetch(`/api/generate_password?length=${length}&symbols=${symbols}`);
            const data = await response.json();
            
            document.getElementById('generatedPassword').value = data.password;
            document.getElementById('generatedPasswordStrength').innerHTML = 
                `<span class="strength-${data.strength.toLowerCase().replace(' ', '-')}">${data.strength}</span> (${data.entropy.toFixed(1)} bits)`;
        } catch (error) {
            alert('Error generating password: ' + error.message);
        }
    }
    
    // Copy to clipboard with better feedback
    async function copyToClipboard(inputId) {
        const input = document.getElementById(inputId);
        const button = event.target.closest('button');
        const originalContent = button.innerHTML;
        
        try {
            await navigator.clipboard.writeText(input.value);
            
            // Show success feedback
            button.innerHTML = '<i class="bi bi-check"></i>';
            button.classList.add('copy-feedback');
            
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.classList.remove('copy-feedback');
            }, 2000);
        } catch (err) {
            // Fallback for older browsers
            input.select();
            document.execCommand('copy');
            
            button.innerHTML = '<i class="bi bi-check"></i>';
            setTimeout(() => {
                button.innerHTML = originalContent;
            }, 2000);
        }
    }
    
    // Copy password from table
    async function copyPassword(service, username) {
        try {
            const response = await fetch('/api/entries/get_password', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({service, username})
            });
            
            if (response.ok) {
                const data = await response.json();
                await navigator.clipboard.writeText(data.password);
                
                // Show toast notification
                showToast('Password copied to clipboard!', 'success');
            } else {
                const error = await response.json();
                showToast('Error: ' + error.error, 'danger');
            }
        } catch (error) {
            showToast('Error copying password: ' + error.message, 'danger');
        }
    }
    
    // View password in modal
    async function viewPassword(service, username) {
        try {
            const response = await fetch('/api/entries/get_password', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({service, username})
            });
            
            if (response.ok) {
                const data = await response.json();
                document.getElementById('viewPasswordService').textContent = service;
                document.getElementById('viewPasswordField').value = data.password;
                new bootstrap.Modal(document.getElementById('viewPasswordModal')).show();
            } else {
                const error = await response.json();
                alert('Error: ' + error.error);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    // Edit entry
    async function editEntry(service, username) {
        try {
            const response = await fetch('/api/entries/get_entry', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({service, username})
            });
            
            if (response.ok) {
                const data = await response.json();
                
                // Populate edit form
                document.getElementById('editOriginalService').value = service;
                document.getElementById('editOriginalUsername').value = username;
                document.getElementById('editService').value = data.service;
                document.getElementById('editUsername').value = data.username;
                document.getElementById('editPassword').value = data.password;
                document.getElementById('editUrl').value = data.url;
                document.getElementById('editNotes').value = data.notes;
                
                // Show modal
                new bootstrap.Modal(document.getElementById('editEntryModal')).show();
            } else {
                const error = await response.json();
                alert('Error: ' + error.error);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    // Delete entry
    async function deleteEntry(service, username) {
        if (!confirm(`Delete password for ${service}?`)) return;
        
        try {
            const response = await fetch('/api/entries/delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({service, username})
            });
            
            if (response.ok) {
                showToast('Entry deleted successfully', 'success');
                location.reload();
            } else {
                const error = await response.json();
                showToast('Error: ' + error.error, 'danger');
            }
        } catch (error) {
            showToast('Network error: ' + error.message, 'danger');
        }
    }
    
    // Show toast notification
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toastContainer') || createToastContainer();
        
        const toastId = 'toast_' + Date.now();
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.id = toastId;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        const bsToast = new bootstrap.Toast(toast, {delay: 3000});
        bsToast.show();
        
        // Remove after hide
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }
    
    function createToastContainer() {
        const container = document.createElement('div');
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.id = 'toastContainer';
        document.body.appendChild(container);
        return container;
    }
    
    // Refresh entries
    function refreshEntries() {
        location.reload();
    }
</script>
{% endblock %}
